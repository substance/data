<!DOCTYPE html>  <html> <head>   <title>data.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               data.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <pre><code>(c) 2011 Michael Aufreiter
Data.js is freely distributable under the MIT license.
Portions of Daja.js are inspired or borrowed from Underscore.js,
Backbone.js and Google's Visualization API.
For all details and documentation:
http://substance.io/#michael/data-js
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="p">(</span><span class="kd">function</span><span class="p">(){</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h2>Initial Setup</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>The top-level namespace. All public Data.js classes and modules will
be attached to this. Exported for both CommonJS and the browser.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">Data</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">exports</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">Data</span> <span class="o">=</span> <span class="nx">exports</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">Data</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">Data</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="p">}</span>
  </pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Current version of the library. Keep in sync with <code>package.json</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">Data</span><span class="p">.</span><span class="nx">VERSION</span> <span class="o">=</span> <span class="s1">&#39;0.2.1&#39;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Require Underscore, if we're on the server, and it's not already present.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">_</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">require</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">))</span> <span class="nx">_</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;underscore&quot;</span><span class="p">);</span>
  
  </pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <h2>Top Level API</h2>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">Data</span><span class="p">.</span><span class="nx">VALUE_TYPES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;string&#39;</span><span class="p">,</span>
    <span class="s1">&#39;object&#39;</span><span class="p">,</span>
    <span class="s1">&#39;number&#39;</span><span class="p">,</span>
    <span class="s1">&#39;boolean&#39;</span><span class="p">,</span>
    <span class="s1">&#39;date&#39;</span>
  <span class="p">];</span>
  
  <span class="nx">Data</span><span class="p">.</span><span class="nx">isValueType</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">include</span><span class="p">(</span><span class="nx">Data</span><span class="p">.</span><span class="nx">VALUE_TYPES</span><span class="p">,</span> <span class="nx">type</span><span class="p">);</span>
  <span class="p">};</span>
  </pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Set a new Data.Adapter and enable Persistence API</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">Data</span><span class="p">.</span><span class="nx">setAdapter</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">config</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">exports</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">Adapter</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./adapters/&#39;</span><span class="o">+</span><span class="nx">name</span><span class="o">+</span><span class="s1">&#39;_adapter&#39;</span><span class="p">);</span>
      <span class="nx">Data</span><span class="p">.</span><span class="nx">adapter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Adapter</span><span class="p">(</span><span class="nx">config</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">Data</span><span class="p">.</span><span class="nx">adapter</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">window</span><span class="p">[</span><span class="nx">name</span><span class="p">](</span><span class="nx">config</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">};</span>
  </pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Middleware registration</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">Data</span><span class="p">.</span><span class="nx">middleware</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">readgraph</span><span class="o">:</span> <span class="p">[],</span>
    <span class="nx">writegraph</span><span class="o">:</span> <span class="p">[]</span>
  <span class="p">};</span>
  
  <span class="cm">/*!</span>
<span class="cm">  Math.uuid.js (v1.4)</span>
<span class="cm">  http://www.broofa.com</span>
<span class="cm">  mailto:robert@broofa.com</span>

<span class="cm">  Copyright (c) 2010 Robert Kieffer</span>
<span class="cm">  Dual licensed under the MIT and GPL licenses.</span>
<span class="cm">  */</span>

  <span class="nx">Data</span><span class="p">.</span><span class="nx">uuid</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">prefix</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">chars</span> <span class="o">=</span> <span class="s1">&#39;0123456789abcdefghijklmnopqrstuvwxyz&#39;</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">),</span>
        <span class="nx">uuid</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="nx">radix</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
        <span class="nx">len</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">len</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Compact form</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="nx">uuid</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">chars</span><span class="p">[</span><span class="mi">0</span> <span class="o">|</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="o">*</span><span class="nx">radix</span><span class="p">];</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>rfc4122, version 4 form</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">r</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>rfc4122 requires these characters</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">uuid</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="nx">uuid</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="nx">uuid</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">=</span> <span class="nx">uuid</span><span class="p">[</span><span class="mi">23</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span><span class="p">;</span>
      <span class="nx">uuid</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;4&#39;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Fill in random data.  At i==19 set the high bits of clock sequence as
per rfc4122, sec. 4.1.5</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">36</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">uuid</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="p">{</span>
          <span class="nx">r</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">|</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="o">*</span><span class="mi">16</span><span class="p">;</span>
          <span class="nx">uuid</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">chars</span><span class="p">[(</span><span class="nx">i</span> <span class="o">==</span> <span class="mi">19</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="nx">r</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x8</span> <span class="o">:</span> <span class="nx">r</span><span class="p">];</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="k">return</span> <span class="p">(</span><span class="nx">prefix</span> <span class="o">?</span> <span class="nx">prefix</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="nx">uuid</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <h2>Helpers</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <h2>_.Events (borrowed from Backbone.js)</h2>             </td>             <td class="code">               <div class="highlight"><pre>  </pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>A module that can be mixed in to <em>any object</em> in order to provide it with
custom events. You may <code>bind</code> or <code>unbind</code> a callback function to an event;
<code>trigger</code>-ing an event fires all callbacks in succession.</p>

<pre><code>var object = {};
_.extend(object, Backbone.Events);
object.bind('expand', function(){ alert('expanded'); });
object.trigger('expand');
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>  
  <span class="nx">_</span><span class="p">.</span><span class="nx">Events</span> <span class="o">=</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Bind an event, specified by a string name, <code>ev</code>, to a <code>callback</code> function.
Passing <code>"all"</code> will bind the callback to all events fired.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">bind</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ev</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">calls</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_callbacks</span> <span class="o">||</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_callbacks</span> <span class="o">=</span> <span class="p">{});</span>
      <span class="kd">var</span> <span class="nx">list</span>  <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_callbacks</span><span class="p">[</span><span class="nx">ev</span><span class="p">]</span> <span class="o">||</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_callbacks</span><span class="p">[</span><span class="nx">ev</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]);</span>
      <span class="nx">list</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">callback</span><span class="p">);</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Remove one or many callbacks. If <code>callback</code> is null, removes all
callbacks for the event. If <code>ev</code> is null, removes all bound callbacks
for all events.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">unbind</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ev</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">calls</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">ev</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_callbacks</span> <span class="o">=</span> <span class="p">{};</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">calls</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_callbacks</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">calls</span><span class="p">[</span><span class="nx">ev</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">list</span> <span class="o">=</span> <span class="nx">calls</span><span class="p">[</span><span class="nx">ev</span><span class="p">];</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">list</span><span class="p">)</span> <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
          <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">list</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">callback</span> <span class="o">===</span> <span class="nx">list</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="p">{</span>
              <span class="nx">list</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
              <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Trigger an event, firing all bound callbacks. Callbacks are passed the
same arguments as <code>trigger</code> is, apart from the event name.
Listening for <code>"all"</code> passes the true event name as the first argument.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">trigger</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ev</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">list</span><span class="p">,</span> <span class="nx">calls</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">l</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">calls</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_callbacks</span><span class="p">))</span> <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">list</span> <span class="o">=</span> <span class="nx">calls</span><span class="p">[</span><span class="nx">ev</span><span class="p">])</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">list</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">list</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">list</span> <span class="o">=</span> <span class="nx">calls</span><span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">])</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">list</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">list</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Shared empty constructor function to aid in prototype-chain creation.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">ctor</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){};</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Helper function to correctly set up the prototype chain, for subclasses.
Similar to <code>goog.inherits</code>, but uses a hash of prototype properties and
class properties to be extended.
Taken from Underscore.js (c) Jeremy Ashkenas</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">inherits</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">parent</span><span class="p">,</span> <span class="nx">protoProps</span><span class="p">,</span> <span class="nx">staticProps</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">child</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>The constructor function for the new subclass is either defined by you
(the "constructor" property in your <code>extend</code> definition), or defaulted
by us to simply call <code>super()</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">protoProps</span> <span class="o">&amp;&amp;</span> <span class="nx">protoProps</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="s1">&#39;constructor&#39;</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">child</span> <span class="o">=</span> <span class="nx">protoProps</span><span class="p">.</span><span class="nx">constructor</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">child</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span> <span class="k">return</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span> <span class="p">};</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Set the prototype chain to inherit from <code>parent</code>, without calling
<code>parent</code>'s constructor function.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">ctor</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span>
    <span class="nx">child</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ctor</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Add prototype properties (instance properties) to the subclass,
if supplied.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">protoProps</span><span class="p">)</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">child</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="nx">protoProps</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Add static properties to the constructor function, if supplied.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">staticProps</span><span class="p">)</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">child</span><span class="p">,</span> <span class="nx">staticProps</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Correctly set child's <code>prototype.constructor</code>, for <code>instanceof</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">child</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">=</span> <span class="nx">child</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Set a convenience property in case the parent's prototype is needed later.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">child</span><span class="p">.</span><span class="nx">__super__</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span>

    <span class="k">return</span> <span class="nx">child</span><span class="p">;</span>
  <span class="p">};</span>
  
  </pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <h2>Data.Hash</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>A Hash data structure that provides a simple layer of abstraction for
managing a sortable data-structure with hash semantics. It's heavily
used throughout Data.js.</p>             </td>             <td class="code">               <div class="highlight"><pre>  
  <span class="nx">Data</span><span class="p">.</span><span class="nx">Hash</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">keyOrder</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">data</span> <span class="k">instanceof</span> <span class="nb">Array</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">datum</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">that</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="nx">datum</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">data</span> <span class="k">instanceof</span> <span class="nb">Object</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">datum</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">that</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">datum</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">}</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">initialize</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">initialize</span><span class="p">(</span><span class="nx">attributes</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">Data</span><span class="p">.</span><span class="nx">Hash</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">Events</span><span class="p">,</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Returns a copy of the Hash
Used by transformation methods</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">clone</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">copy</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Data</span><span class="p">.</span><span class="nx">Hash</span><span class="p">();</span>
      <span class="nx">copy</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">copy</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
      <span class="p">});</span>
      <span class="nx">copy</span><span class="p">.</span><span class="nx">keyOrder</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">keyOrder</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">keyOrder</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">copy</span><span class="p">;</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Set a value at a given <em>key</em></p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">set</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">targetIndex</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">index</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">key</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">key</span><span class="p">])</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">targetIndex</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// insert at a given index</span>
          <span class="kd">var</span> <span class="nx">front</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">targetIndex</span><span class="p">;</span>
          <span class="p">});</span>

          <span class="kd">var</span> <span class="nx">back</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="nx">targetIndex</span><span class="p">;</span>
          <span class="p">});</span>

          <span class="k">this</span><span class="p">.</span><span class="nx">keyOrder</span> <span class="o">=</span> <span class="p">[].</span><span class="nx">concat</span><span class="p">(</span><span class="nx">front</span><span class="p">.</span><span class="nx">keyOrder</span><span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">keyOrder</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">keyOrder</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">keyOrder</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">back</span><span class="p">.</span><span class="nx">keyOrder</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">keyOrder</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">index</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">length</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">index</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">index</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
      <span class="k">this</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;set&#39;</span><span class="p">,</span> <span class="nx">key</span><span class="p">);</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Delete entry at given <em>key</em></p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">del</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">key</span><span class="p">])</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">l</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">index</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
        <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">keyOrder</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">splice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="nx">l</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;del&#39;</span><span class="p">,</span> <span class="nx">key</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Get value at given <em>key</em></p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Get value at given <em>index</em></p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">at</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">keyOrder</span><span class="p">[</span><span class="nx">index</span><span class="p">];</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>Get first item</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">first</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">at</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>Get last item</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">last</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">at</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>Returns for an index the corresponding <em>key</em></p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">key</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">keyOrder</span><span class="p">[</span><span class="nx">index</span><span class="p">];</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>Returns for a given <em>key</em> the corresponding <em>index</em></p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">index</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">keyOrder</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>Iterate over values contained in the <code>Data.Hash</code></p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">each</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">keyOrder</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">fn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">key</span><span class="p">],</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">index</span><span class="p">);</span>
      <span class="p">});</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>Convert to an ordinary JavaScript Array containing just the values</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">values</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
      <span class="p">});</span>
      <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>Returns all keys in current order</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">keys</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">keyOrder</span><span class="p">;</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>Convert to an ordinary JavaScript Array containing
key value pairs. Used by <code>sort</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">toArray</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">[];</span>
    
      <span class="k">this</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">key</span><span class="o">:</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="nx">value</span><span class="p">});</span>
      <span class="p">});</span>
    
      <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>Serialize</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">toJSON</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">{};</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">result</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">toJSON</span> <span class="o">?</span> <span class="nx">value</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">()</span> <span class="o">:</span> <span class="nx">value</span><span class="p">;</span>
      <span class="p">});</span>
      <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>Map the <code>Data.Hash</code> to your needs</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">map</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">clone</span><span class="p">(),</span>
          <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      <span class="nx">result</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">result</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">that</span><span class="p">.</span><span class="nx">key</span><span class="p">(</span><span class="nx">index</span><span class="p">)]</span> <span class="o">=</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="nx">item</span><span class="p">);</span>
      <span class="p">});</span>
      <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>Select items that match some conditions expressed by a matcher function</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">select</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Data</span><span class="p">.</span><span class="nx">Hash</span><span class="p">(),</span>
          <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    
      <span class="k">this</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">fn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">index</span><span class="p">))</span> <span class="p">{</span>
          <span class="nx">result</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">});</span>
      <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>Performs a sort</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">sort</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">comparator</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">clone</span><span class="p">();</span>
          <span class="nx">sortedKeys</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">toArray</span><span class="p">().</span><span class="nx">sort</span><span class="p">(</span><span class="nx">comparator</span><span class="p">);</span>
    </pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>update keyOrder</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">result</span><span class="p">.</span><span class="nx">keyOrder</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">sortedKeys</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">k</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">k</span><span class="p">.</span><span class="nx">key</span><span class="p">;</span>
      <span class="p">});</span>
      <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>Performs an intersection with the given <em>hash</em></p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">intersect</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">hash</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span>
      <span class="nx">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Data</span><span class="p">.</span><span class="nx">Hash</span><span class="p">();</span>
    
      <span class="k">this</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">hash</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value2</span><span class="p">,</span> <span class="nx">key2</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">key</span> <span class="o">===</span> <span class="nx">key2</span><span class="p">)</span> <span class="nx">result</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
        <span class="p">});</span>
      <span class="p">});</span>
      <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>Performs an union with the given <em>hash</em></p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">union</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">hash</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span>
      <span class="nx">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Data</span><span class="p">.</span><span class="nx">Hash</span><span class="p">();</span>
    
      <span class="k">this</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">result</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">))</span>
          <span class="nx">result</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
      <span class="p">});</span>
      <span class="nx">hash</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">result</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">))</span>
          <span class="nx">result</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
      <span class="p">});</span>
      <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">});</span>
  
  </pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <h2>Data.Comparators</h2>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">Data</span><span class="p">.</span><span class="nx">Comparators</span> <span class="o">=</span> <span class="p">{};</span>
  
  <span class="nx">Data</span><span class="p">.</span><span class="nx">Comparators</span><span class="p">.</span><span class="nx">ASC</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">item1</span><span class="p">,</span> <span class="nx">item2</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">item1</span><span class="p">.</span><span class="nx">value</span> <span class="o">===</span> <span class="nx">item2</span><span class="p">.</span><span class="nx">value</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="p">(</span><span class="nx">item1</span><span class="p">.</span><span class="nx">value</span> <span class="o">&lt;</span> <span class="nx">item2</span><span class="p">.</span><span class="nx">value</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">Data</span><span class="p">.</span><span class="nx">Comparators</span><span class="p">.</span><span class="nx">DESC</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">item1</span><span class="p">,</span> <span class="nx">item2</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">item1</span><span class="p">.</span><span class="nx">value</span> <span class="o">===</span> <span class="nx">item2</span><span class="p">.</span><span class="nx">value</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="p">(</span><span class="nx">item1</span><span class="p">.</span><span class="nx">value</span> <span class="o">&gt;</span> <span class="nx">item2</span><span class="p">.</span><span class="nx">value</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>
  <span class="p">};</span>
  
  </pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <h2>Data.Aggregators</h2>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">Data</span><span class="p">.</span><span class="nx">Aggregators</span> <span class="o">=</span> <span class="p">{};</span>

  <span class="nx">Data</span><span class="p">.</span><span class="nx">Aggregators</span><span class="p">.</span><span class="nx">SUM</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">values</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="nx">values</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">result</span> <span class="o">+=</span> <span class="nx">value</span><span class="p">;</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">Data</span><span class="p">.</span><span class="nx">Aggregators</span><span class="p">.</span><span class="nx">MIN</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">values</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="kc">Infinity</span><span class="p">;</span>
    <span class="nx">values</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">&lt;</span> <span class="nx">result</span><span class="p">)</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">Data</span><span class="p">.</span><span class="nx">Aggregators</span><span class="p">.</span><span class="nx">MAX</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">values</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="o">-</span><span class="kc">Infinity</span><span class="p">;</span>
    <span class="nx">values</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">&gt;</span> <span class="nx">result</span><span class="p">)</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">Data</span><span class="p">.</span><span class="nx">Aggregators</span><span class="p">.</span><span class="nx">AVG</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">values</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Data</span><span class="p">.</span><span class="nx">Aggregators</span><span class="p">.</span><span class="nx">SUM</span><span class="p">(</span><span class="nx">values</span><span class="p">)</span> <span class="o">/</span> <span class="nx">values</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">Data</span><span class="p">.</span><span class="nx">Aggregators</span><span class="p">.</span><span class="nx">COUNT</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">values</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">values</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
  <span class="p">};</span>
  
  </pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <h2>Data.Modifiers</h2>             </td>             <td class="code">               <div class="highlight"><pre>  
  <span class="nx">Data</span><span class="p">.</span><span class="nx">Modifiers</span> <span class="o">=</span> <span class="p">{};</span></pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>The default modifier simply does nothing</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">Data</span><span class="p">.</span><span class="nx">Modifiers</span><span class="p">.</span><span class="nx">DEFAULT</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">attribute</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">attribute</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">Data</span><span class="p">.</span><span class="nx">Modifiers</span><span class="p">.</span><span class="nx">MONTH</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">attribute</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">attribute</span><span class="p">.</span><span class="nx">getMonth</span><span class="p">();</span>
  <span class="p">};</span>

  <span class="nx">Data</span><span class="p">.</span><span class="nx">Modifiers</span><span class="p">.</span><span class="nx">QUARTER</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">attribute</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">attribute</span><span class="p">.</span><span class="nx">getMonth</span><span class="p">()</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">};</span>
  
  </pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <h2>Data.Transformers</h2>             </td>             <td class="code">               <div class="highlight"><pre>  
  <span class="nx">Data</span><span class="p">.</span><span class="nx">Transformers</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">group</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">g</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">keys</span><span class="p">,</span> <span class="nx">properties</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">gspec</span> <span class="o">=</span> <span class="p">{},</span>
          <span class="nx">type</span> <span class="o">=</span> <span class="nx">g</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">type</span><span class="p">),</span>
          <span class="nx">groups</span> <span class="o">=</span> <span class="p">{},</span>
          <span class="nx">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      
      <span class="nx">gspec</span><span class="p">[</span><span class="nx">type</span><span class="p">.</span><span class="nx">_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="o">:</span> <span class="s2">&quot;/type/type&quot;</span><span class="p">,</span> <span class="s2">&quot;properties&quot;</span><span class="o">:</span> <span class="p">{}};</span></pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <p>Include group keys to the output graph</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">keys</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">gspec</span><span class="p">[</span><span class="nx">type</span><span class="p">.</span><span class="nx">_id</span><span class="p">].</span><span class="nx">properties</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">type</span><span class="p">.</span><span class="nx">properties</span><span class="p">().</span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">).</span><span class="nx">toJSON</span><span class="p">();</span>
      <span class="p">});</span>
      </pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>Include additional properties</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">properties</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="nx">type</span><span class="p">.</span><span class="nx">properties</span><span class="p">().</span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">).</span><span class="nx">toJSON</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span> <span class="nx">p</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
        <span class="nx">gspec</span><span class="p">[</span><span class="nx">type</span><span class="p">.</span><span class="nx">_id</span><span class="p">].</span><span class="nx">properties</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">p</span><span class="p">;</span>
      <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>Compute group memberships</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">keys</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">groups</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">type</span><span class="p">.</span><span class="nx">properties</span><span class="p">().</span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">).</span><span class="nx">all</span><span class="p">(</span><span class="s1">&#39;values&#39;</span><span class="p">);</span>
      <span class="p">});</span>

      <span class="kd">function</span> <span class="nx">aggregate</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">members</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Data</span><span class="p">.</span><span class="nx">Hash</span><span class="p">();</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">keys</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">k</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">objects</span> <span class="o">=</span> <span class="nx">groups</span><span class="p">[</span><span class="nx">keys</span><span class="p">[</span><span class="nx">index</span><span class="p">]].</span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">[</span><span class="nx">index</span><span class="p">]).</span><span class="nx">referencedObjects</span><span class="p">;</span>
          <span class="nx">members</span> <span class="o">=</span> <span class="nx">index</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">?</span> <span class="nx">members</span><span class="p">.</span><span class="nx">union</span><span class="p">(</span><span class="nx">objects</span><span class="p">)</span> <span class="o">:</span> <span class="nx">members</span><span class="p">.</span><span class="nx">intersect</span><span class="p">(</span><span class="nx">objects</span><span class="p">);</span>
        <span class="p">});</span>
        
        
        <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="p">{</span><span class="nx">type</span><span class="o">:</span> <span class="nx">type</span><span class="p">.</span><span class="nx">_id</span><span class="p">};</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">gspec</span><span class="p">[</span><span class="nx">type</span><span class="p">.</span><span class="nx">_id</span><span class="p">].</span><span class="nx">properties</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="nx">pk</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">include</span><span class="p">(</span><span class="nx">keys</span><span class="p">,</span> <span class="nx">pk</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">res</span><span class="p">[</span><span class="nx">pk</span><span class="p">]</span> <span class="o">=</span> <span class="nx">key</span><span class="p">[</span><span class="nx">_</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">keys</span><span class="p">,</span> <span class="nx">pk</span><span class="p">)];</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">numbers</span> <span class="o">=</span> <span class="nx">members</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">return</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">pk</span><span class="p">);</span>
            <span class="p">});</span>
            <span class="kd">var</span> <span class="nx">aggregator</span> <span class="o">=</span> <span class="nx">properties</span><span class="p">[</span><span class="nx">pk</span><span class="p">].</span><span class="nx">aggregator</span> <span class="o">||</span> <span class="nx">Data</span><span class="p">.</span><span class="nx">Aggregators</span><span class="p">.</span><span class="nx">SUM</span>
            <span class="nx">res</span><span class="p">[</span><span class="nx">pk</span><span class="p">]</span> <span class="o">=</span> <span class="nx">aggregator</span><span class="p">(</span><span class="nx">numbers</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">});</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="kd">function</span> <span class="nx">extractGroups</span><span class="p">(</span><span class="nx">keyIndex</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">keyIndex</span> <span class="o">===</span> <span class="nx">keys</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">gspec</span><span class="p">[</span><span class="nx">key</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;::&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="nx">aggregate</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">keyIndex</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
          <span class="nx">groups</span><span class="p">[</span><span class="nx">keys</span><span class="p">[</span><span class="nx">keyIndex</span><span class="p">]].</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">grp</span><span class="p">,</span> <span class="nx">grpkey</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">extractGroups</span><span class="p">(</span><span class="nx">keyIndex</span><span class="p">,</span> <span class="nx">key</span><span class="p">.</span><span class="nx">concat</span><span class="p">([</span><span class="nx">grpkey</span><span class="p">]));</span>
          <span class="p">});</span>
        <span class="p">}</span>
      <span class="p">}</span>

      <span class="nx">extractGroups</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">[]);</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nx">Data</span><span class="p">.</span><span class="nx">Graph</span><span class="p">(</span><span class="nx">gspec</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">};</span>
  
  </pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <h2>Data.Node</h2>             </td>             <td class="code">               <div class="highlight"><pre>  </pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <p>JavaScript Node implementation that hides graph complexity from
the interface. It introduces properties, which group types of edges
together. Therefore multi-partite graphs are possible without any hassle.
Every Node simply contains properties which conform to outgoing edges.
It makes heavy use of hashing through JavaScript object properties to
allow random access whenever possible. If I've got it right, it should 
perform sufficiently fast, allowing speedy graph traversals.</p>             </td>             <td class="code">               <div class="highlight"><pre>  
  <span class="nx">Data</span><span class="p">.</span><span class="nx">Node</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">nodeId</span> <span class="o">=</span> <span class="nx">Data</span><span class="p">.</span><span class="nx">Node</span><span class="p">.</span><span class="nx">generateId</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">val</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_properties</span> <span class="o">=</span> <span class="p">{};</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">initialize</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">initialize</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
  <span class="p">};</span>
  
  <span class="nx">Data</span><span class="p">.</span><span class="nx">Node</span><span class="p">.</span><span class="nx">nodeCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  </pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p>Generates a unique id for each node</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">Data</span><span class="p">.</span><span class="nx">Node</span><span class="p">.</span><span class="nx">generateId</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Data</span><span class="p">.</span><span class="nx">Node</span><span class="p">.</span><span class="nx">nodeCount</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">};</span>
  
  <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">Data</span><span class="p">.</span><span class="nx">Node</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">Events</span><span class="p">,</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <p>Node identity, which is simply the node's id</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">identity</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">nodeId</span><span class="p">;</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <p>Replace a property with a complete <code>Hash</code></p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">replace</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">property</span><span class="p">,</span> <span class="nx">hash</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_properties</span><span class="p">[</span><span class="nx">property</span><span class="p">]</span> <span class="o">=</span> <span class="nx">hash</span><span class="p">;</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <p>Set a Node's property</p>

<p>Takes a property key, a value key and value. Values that aren't
instances of <code>Data.Node</code> wrapped are automatically.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">set</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">property</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">_properties</span><span class="p">[</span><span class="nx">property</span><span class="p">])</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_properties</span><span class="p">[</span><span class="nx">property</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Data</span><span class="p">.</span><span class="nx">Hash</span><span class="p">();</span>
      <span class="p">}</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_properties</span><span class="p">[</span><span class="nx">property</span><span class="p">].</span><span class="nx">set</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">instanceof</span> <span class="nx">Data</span><span class="p">.</span><span class="nx">Node</span> <span class="o">?</span> <span class="nx">value</span> <span class="o">:</span> <span class="k">new</span> <span class="nx">Data</span><span class="p">.</span><span class="nx">Node</span><span class="p">({</span><span class="nx">value</span><span class="o">:</span> <span class="nx">value</span><span class="p">}));</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-63">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-63">&#182;</a>               </div>               <p>Get node for given <em>property</em> at given <em>key</em></p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">property</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">key</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">_properties</span><span class="p">[</span><span class="nx">property</span><span class="p">]</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_properties</span><span class="p">[</span><span class="nx">property</span><span class="p">].</span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-64">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-64">&#182;</a>               </div>               <p>Get all connected nodes at given <em>property</em></p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">all</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">property</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_properties</span><span class="p">[</span><span class="nx">property</span><span class="p">];</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-65">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-65">&#182;</a>               </div>               <p>Get first connected node at given <em>property</em></p>

<p>Useful if you want to mimic the behavior of unique properties.
That is, if you know that there's always just one associated node
at a given property.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">first</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">property</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_properties</span><span class="p">[</span><span class="nx">property</span><span class="p">];</span>
      <span class="k">return</span> <span class="nx">p</span> <span class="o">?</span> <span class="nx">p</span><span class="p">.</span><span class="nx">first</span><span class="p">()</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>  
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-66">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-66">&#182;</a>               </div>               <p>Value of first connected target node at given <em>property</em></p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">value</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">property</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">values</span><span class="p">(</span><span class="nx">property</span><span class="p">).</span><span class="nx">first</span><span class="p">();</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-67">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-67">&#182;</a>               </div>               <p>Values of associated target nodes for non-unique properties</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">values</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">property</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">property</span><span class="p">))</span> <span class="k">return</span> <span class="k">new</span> <span class="nx">Data</span><span class="p">.</span><span class="nx">Hash</span><span class="p">();</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">property</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">n</span><span class="p">.</span><span class="nx">val</span><span class="p">;</span>
      <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">});</span>
  
  </pre></div>             </td>           </tr>                               <tr id="section-68">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-68">&#182;</a>               </div>               <h2>Data.Adapter</h2>             </td>             <td class="code">               <div class="highlight"><pre>  </pre></div>             </td>           </tr>                               <tr id="section-69">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-69">&#182;</a>               </div>               <p>An abstract interface for writing and reading Data.Graphs.</p>             </td>             <td class="code">               <div class="highlight"><pre>  
  <span class="nx">Data</span><span class="p">.</span><span class="nx">Adapter</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-70">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-70">&#182;</a>               </div>               <p>The config object is used to describe database credentials</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">config</span> <span class="o">=</span> <span class="nx">config</span><span class="p">;</span>
  <span class="p">};</span>
  
  <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">Data</span><span class="p">.</span><span class="nx">Adapter</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="p">{</span>
    </pre></div>             </td>           </tr>                               <tr id="section-71">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-71">&#182;</a>               </div>               <p>Flush the database</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">flush</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-72">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-72">&#182;</a>               </div>               <p>Takes a query object to match objects in the database 
and return them as a Data.Graph</p>

<p>Fetch all nodes of <code>/type/document</code>:</p>

<pre><code> {
   "type": "/type/document"
 }
</code></pre>

<p>Fetch all nodes of <code>/type/document</code> associated with user <code>/user/michael</code></p>

<pre><code> {
   "type": "/type/document"
   "user": "/user/michael"
 }
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">readGraph</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">qry</span><span class="p">,</span> <span class="nx">targetGraph</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-73">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-73">&#182;</a>               </div>               <p>Takes a serialized graph object and persists it</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">writeGraph</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">graph</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{}</span>
  <span class="p">});</span>
  
  </pre></div>             </td>           </tr>                               <tr id="section-74">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-74">&#182;</a>               </div>               <h2>Data.Property</h2>             </td>             <td class="code">               <div class="highlight"><pre>  </pre></div>             </td>           </tr>                               <tr id="section-75">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-75">&#182;</a>               </div>               <p>Meta-data (data about data) is represented as a set of properties that
belongs to a certain <code>Data.Type</code>. A <code>Data.Property</code> holds a key, a name
and an expected type, telling whether the data is numeric or textual, etc.</p>             </td>             <td class="code">               <div class="highlight"><pre>  
  <span class="nx">Data</span><span class="p">.</span><span class="nx">Property</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">inherits</span><span class="p">(</span><span class="nx">Data</span><span class="p">.</span><span class="nx">Node</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">constructor</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">Data</span><span class="p">.</span><span class="nx">Node</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">key</span> <span class="o">=</span> <span class="nx">id</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_id</span> <span class="o">=</span> <span class="nx">id</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="nx">type</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">unique</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">unique</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">meta</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">meta</span> <span class="o">||</span> <span class="p">{};</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">validator</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">validator</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">required</span> <span class="o">=</span> <span class="nx">options</span><span class="p">[</span><span class="s2">&quot;required&quot;</span><span class="p">];</span>
      <span class="k">this</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">options</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">];</span>
      </pre></div>             </td>           </tr>                               <tr id="section-76">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-76">&#182;</a>               </div>               <p>TODO: ensure that object and value types are not mixed</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">this</span><span class="p">.</span><span class="nx">expectedTypes</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">options</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nx">options</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="p">[</span><span class="nx">options</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]];</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;values&#39;</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Data</span><span class="p">.</span><span class="nx">Hash</span><span class="p">());</span>
    <span class="p">},</span>
    
    <span class="nx">isValueType</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">Data</span><span class="p">.</span><span class="nx">isValueType</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">expectedTypes</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="p">},</span>
    
    <span class="nx">isObjectType</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">isValueType</span><span class="p">();</span>
    <span class="p">},</span>
    
    <span class="nx">registerValue</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">obj</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-77">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-77">&#182;</a>               </div>               <p>Value could be an object or value depending on the property</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">isObjectType</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;values&#39;</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">val</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;values&#39;</span><span class="p">,</span> <span class="nx">key</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">val</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Data</span><span class="p">.</span><span class="nx">Node</span><span class="p">({</span><span class="nx">value</span><span class="o">:</span> <span class="nx">value</span><span class="p">});</span>
          <span class="nx">val</span><span class="p">.</span><span class="nx">referencedObjects</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Data</span><span class="p">.</span><span class="nx">Hash</span><span class="p">();</span>
        <span class="p">}</span>
        
        <span class="nx">obj</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">key</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">val</span><span class="p">);</span>
        <span class="nx">val</span><span class="p">.</span><span class="nx">referencedObjects</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">key</span><span class="p">,</span> <span class="nx">obj</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;values&#39;</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">val</span><span class="p">);</span> <span class="c1">// vals are shared among objects</span>
      <span class="p">}</span>
    <span class="p">},</span>
    
    <span class="nx">unregisterValue</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">isObjectType</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="s1">&#39;values&#39;</span><span class="p">).</span><span class="nx">del</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-78">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-78">&#182;</a>               </div>               <p>Aggregates the property's values</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">aggregate</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">fn</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">values</span><span class="p">(</span><span class="s2">&quot;values&quot;</span><span class="p">));</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-79">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-79">&#182;</a>               </div>               <p>Serialize a propery definition</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">toJSON</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="p">{</span>
        <span class="nx">name</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
        <span class="nx">type</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">expectedTypes</span><span class="p">,</span>
        <span class="nx">unique</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">unique</span><span class="p">,</span>
        <span class="nx">meta</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">meta</span><span class="p">,</span>
        <span class="nx">valiate</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">validator</span><span class="p">,</span>
        <span class="nx">required</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">required</span><span class="p">,</span>
        <span class="s2">&quot;default&quot;</span><span class="o">:</span> <span class="k">this</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">});</span>
  
   </pre></div>             </td>           </tr>                               <tr id="section-80">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-80">&#182;</a>               </div>               <h2>Data.Type</h2>             </td>             <td class="code">               <div class="highlight"><pre>  </pre></div>             </td>           </tr>                               <tr id="section-81">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-81">&#182;</a>               </div>               <p>A <code>Data.Type</code> denotes an IS A relationship about a <code>Data.Object</code>. 
For example, if you type the object 'Shakespear' with the type 'Person'
you are saying that Shakespeare IS A person. Types are also used to hold
collections of properties that belong to a certain group of objects.</p>             </td>             <td class="code">               <div class="highlight"><pre>  
  <span class="nx">Data</span><span class="p">.</span><span class="nx">Type</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">inherits</span><span class="p">(</span><span class="nx">Data</span><span class="p">.</span><span class="nx">Node</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">constructor</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">g</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      <span class="nx">Data</span><span class="p">.</span><span class="nx">Node</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
  
      <span class="k">this</span><span class="p">.</span><span class="nx">g</span> <span class="o">=</span> <span class="nx">g</span><span class="p">;</span> <span class="c1">// Belongs to the DataGraph</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">key</span> <span class="o">=</span> <span class="nx">id</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_id</span> <span class="o">=</span> <span class="nx">id</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_rev</span> <span class="o">=</span> <span class="nx">type</span><span class="p">.</span><span class="nx">_rev</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_conflicted</span> <span class="o">=</span> <span class="nx">type</span><span class="p">.</span><span class="nx">_conflicted</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="nx">type</span><span class="p">.</span><span class="nx">type</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">type</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">meta</span> <span class="o">=</span> <span class="nx">type</span><span class="p">.</span><span class="nx">meta</span> <span class="o">||</span> <span class="p">{};</span>
  </pre></div>             </td>           </tr>                               <tr id="section-82">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-82">&#182;</a>               </div>               <p>Extract properties</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">type</span><span class="p">.</span><span class="nx">properties</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">property</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">that</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;properties&#39;</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Data</span><span class="p">.</span><span class="nx">Property</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">property</span><span class="p">));</span>
      <span class="p">});</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-83">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-83">&#182;</a>               </div>               <p>Convenience function for accessing properties</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">properties</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="s1">&#39;properties&#39;</span><span class="p">);</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-84">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-84">&#182;</a>               </div>               <p>Objects of this type</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">objects</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="s1">&#39;objects&#39;</span><span class="p">);</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-85">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-85">&#182;</a>               </div>               <p>Serialize a single type node</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">toJSON</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">_id</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span>
        <span class="nx">_rev</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">_rev</span><span class="p">,</span>
        <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;/type/type&#39;</span><span class="p">,</span>
        <span class="nx">name</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
        <span class="nx">properties</span><span class="o">:</span> <span class="p">{},</span>
        <span class="nx">meta</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">meta</span>
      <span class="p">};</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="s1">&#39;properties&#39;</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">property</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">properties</span><span class="p">[</span><span class="nx">property</span><span class="p">.</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">name</span><span class="o">:</span> <span class="nx">property</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
          <span class="nx">unique</span><span class="o">:</span> <span class="nx">property</span><span class="p">.</span><span class="nx">unique</span><span class="p">,</span>
          <span class="nx">type</span><span class="o">:</span> <span class="nx">property</span><span class="p">.</span><span class="nx">expectedTypes</span><span class="p">,</span>
          <span class="nx">required</span><span class="o">:</span> <span class="nx">property</span><span class="p">.</span><span class="nx">required</span> <span class="o">?</span> <span class="kc">true</span> <span class="o">:</span> <span class="kc">false</span>
        <span class="p">};</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">property</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">])</span> <span class="nx">p</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">property</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">property</span><span class="p">.</span><span class="nx">validator</span><span class="p">)</span> <span class="nx">p</span><span class="p">.</span><span class="nx">validator</span> <span class="o">=</span> <span class="nx">property</span><span class="p">.</span><span class="nx">validator</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">property</span><span class="p">.</span><span class="nx">meta</span> <span class="o">&amp;&amp;</span> <span class="nx">_</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">property</span><span class="p">.</span><span class="nx">meta</span><span class="p">).</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">p</span><span class="p">.</span><span class="nx">meta</span> <span class="o">=</span> <span class="nx">property</span><span class="p">.</span><span class="nx">meta</span><span class="p">;</span>
      <span class="p">});</span>
      
      <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">});</span>
  </pre></div>             </td>           </tr>                               <tr id="section-86">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-86">&#182;</a>               </div>               <h2>Data.Object</h2>             </td>             <td class="code">               <div class="highlight"><pre>  </pre></div>             </td>           </tr>                               <tr id="section-87">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-87">&#182;</a>               </div>               <p>Represents a typed data object within a <code>Data.Graph</code>.
Provides access to properties, defined on the corresponding <code>Data.Type</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>  
  <span class="nx">Data</span><span class="p">.</span><span class="nb">Object</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">inherits</span><span class="p">(</span><span class="nx">Data</span><span class="p">.</span><span class="nx">Node</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">constructor</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">g</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      <span class="nx">Data</span><span class="p">.</span><span class="nx">Node</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">g</span> <span class="o">=</span> <span class="nx">g</span><span class="p">;</span>
      </pre></div>             </td>           </tr>                               <tr id="section-88">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-88">&#182;</a>               </div>               <p>TODO: remove in favor of _id</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">this</span><span class="p">.</span><span class="nx">key</span> <span class="o">=</span> <span class="nx">id</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_id</span> <span class="o">=</span> <span class="nx">id</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">html_id</span> <span class="o">=</span> <span class="nx">id</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\//g</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">dirty</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> <span class="c1">// Every constructed node is dirty by default</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">errors</span> <span class="o">=</span> <span class="p">[];</span> <span class="c1">// Stores validation errors</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_types</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Data</span><span class="p">.</span><span class="nx">Hash</span><span class="p">();</span>
      </pre></div>             </td>           </tr>                               <tr id="section-89">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-89">&#182;</a>               </div>               <p>Associated Data.Objects</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">this</span><span class="p">.</span><span class="nx">referencedObjects</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Data</span><span class="p">.</span><span class="nx">Hash</span><span class="p">();</span>
      </pre></div>             </td>           </tr>                               <tr id="section-90">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-90">&#182;</a>               </div>               <p>Memoize raw data for the build process</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
      </pre></div>             </td>           </tr>                               <tr id="section-91">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-91">&#182;</a>               </div>               <p>Bind function to the set event in order to keep property value links updated</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">this</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;set&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">values</span><span class="p">,</span> <span class="nx">prevValues</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">properties</span><span class="p">().</span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">isObjectType</span><span class="p">())</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-92">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-92">&#182;</a>               </div>               <p>Unregister prev values</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">prevValues</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">p</span><span class="p">.</span><span class="nx">unregisterValue</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">that</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">value</span><span class="p">),</span><span class="nx">that</span><span class="p">);</span>
          <span class="p">});</span>
          </pre></div>             </td>           </tr>                               <tr id="section-93">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-93">&#182;</a>               </div>               <p>Register new values</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">values</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">p</span><span class="p">.</span><span class="nx">registerValue</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">that</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">value</span><span class="p">),</span> <span class="nx">that</span><span class="p">);</span>
          <span class="p">});</span>
        
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// Value type property values</span></pre></div>             </td>           </tr>                               <tr id="section-94">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-94">&#182;</a>               </div>               <p>Unregister prev values</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">prevValues</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">p</span><span class="p">.</span><span class="nx">unregisterValue</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">that</span><span class="p">);</span>
          <span class="p">});</span>
          </pre></div>             </td>           </tr>                               <tr id="section-95">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-95">&#182;</a>               </div>               <p>Register new values</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">values</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">p</span><span class="p">.</span><span class="nx">registerValue</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">that</span><span class="p">);</span>
          <span class="p">});</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-96">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-96">&#182;</a>               </div>               <p>Convenience function for accessing all related types</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">types</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_types</span><span class="p">;</span>
    <span class="p">},</span>
    
    <span class="nx">toString</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">val</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">_id</span><span class="p">;</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-97">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-97">&#182;</a>               </div>               <p>Properties from all associated types</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">properties</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">properties</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Data</span><span class="p">.</span><span class="nx">Hash</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-98">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-98">&#182;</a>               </div>               <p>Prototypal inheritance in action: overriden properties belong to the last type specified</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">this</span><span class="p">.</span><span class="nx">_types</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">type</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="s1">&#39;properties&#39;</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">property</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">properties</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">property</span><span class="p">.</span><span class="nx">key</span><span class="p">,</span> <span class="nx">property</span><span class="p">);</span>
        <span class="p">});</span>
      <span class="p">});</span>
      <span class="k">return</span> <span class="nx">properties</span><span class="p">;</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-99">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-99">&#182;</a>               </div>               <p>After all nodes are recognized the object can be built</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">build</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">types</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">type</span> <span class="o">:</span> <span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">type</span><span class="p">];</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span> <span class="k">throw</span> <span class="s1">&#39;object has no data, and cannot be built&#39;</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      </pre></div>             </td>           </tr>                               <tr id="section-100">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-100">&#182;</a>               </div>               <p>Pull off _id and _rev properties</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">_id</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_rev</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">_rev</span><span class="p">;</span> <span class="c1">// delete this.data._rev;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_conflicted</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">_conflicted</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_deleted</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">_deleted</span><span class="p">;</span> <span class="c1">// delete this.data._deleted;</span>
      </pre></div>             </td>           </tr>                               <tr id="section-101">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-101">&#182;</a>               </div>               <p>Initialize primary type (backward compatibility)</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">this</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;objects&#39;</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">last</span><span class="p">(</span><span class="nx">types</span><span class="p">));</span>
      </pre></div>             </td>           </tr>                               <tr id="section-102">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-102">&#182;</a>               </div>               <p>Initialize types</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">types</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">that</span><span class="p">.</span><span class="nx">_types</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">that</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;objects&#39;</span><span class="p">,</span> <span class="nx">type</span><span class="p">));</span></pre></div>             </td>           </tr>                               <tr id="section-103">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-103">&#182;</a>               </div>               <p>Register properties for all types</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">that</span><span class="p">.</span><span class="nx">_types</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">type</span><span class="p">).</span><span class="nx">all</span><span class="p">(</span><span class="s1">&#39;properties&#39;</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">property</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>        
          <span class="kd">function</span> <span class="nx">applyValue</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">values</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">?</span> <span class="nx">value</span> <span class="o">:</span> <span class="p">[</span><span class="nx">value</span><span class="p">];</span></pre></div>             </td>           </tr>                               <tr id="section-104">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-104">&#182;</a>               </div>               <p>Initialize Property</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">that</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">property</span><span class="p">.</span><span class="nx">key</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Data</span><span class="p">.</span><span class="nx">Hash</span><span class="p">());</span>
            <span class="nx">property</span><span class="p">.</span><span class="nx">isObjectType</span><span class="p">()</span> <span class="o">?</span> <span class="nx">that</span><span class="p">.</span><span class="nx">setObjectProperty</span><span class="p">(</span><span class="nx">property</span><span class="p">,</span> <span class="nx">values</span><span class="p">)</span>
                                    <span class="o">:</span> <span class="nx">that</span><span class="p">.</span><span class="nx">setValueProperty</span><span class="p">(</span><span class="nx">property</span><span class="p">,</span> <span class="nx">values</span><span class="p">);</span>
          <span class="p">}</span>

          <span class="k">if</span> <span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">applyValue</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">key</span><span class="p">]);</span>
          <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">property</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">])</span> <span class="p">{</span>
            <span class="nx">applyValue</span><span class="p">(</span><span class="nx">property</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]);</span>
          <span class="p">}</span>
        <span class="p">});</span>
      <span class="p">});</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">dirty</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;dirty&#39;</span><span class="p">);</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-105">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-105">&#182;</a>               </div>               <p>Validates an object against its type (=schema)</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">validate</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">key</span> <span class="o">===</span> <span class="s1">&#39;/type/type&#39;</span><span class="p">)</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span> <span class="c1">// Skip type nodes</span>
      
      <span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">errors</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">properties</span><span class="p">().</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">property</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-106">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-106">&#182;</a>               </div>               <p>Required property?</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">((</span><span class="nx">that</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">||</span> <span class="nx">that</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="o">||</span> <span class="nx">that</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="o">===</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">property</span><span class="p">.</span><span class="nx">required</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">that</span><span class="p">.</span><span class="nx">errors</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">property</span><span class="o">:</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">message</span><span class="o">:</span> <span class="s2">&quot;Property \&quot;&quot;</span> <span class="o">+</span> <span class="nx">property</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s2">&quot;\&quot; is required&quot;</span><span class="p">});</span>
          <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-107">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-107">&#182;</a>               </div>               <p>Correct type?</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="kd">var</span> <span class="nx">types</span> <span class="o">=</span> <span class="nx">property</span><span class="p">.</span><span class="nx">expectedTypes</span><span class="p">;</span>

          <span class="kd">function</span> <span class="nx">validType</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">types</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">include</span><span class="p">(</span><span class="nx">types</span><span class="p">,</span> <span class="k">typeof</span> <span class="nx">value</span><span class="p">))</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
            </pre></div>             </td>           </tr>                               <tr id="section-108">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-108">&#182;</a>               </div>               <p>FIXME: assumes that unloaded objects are valid properties</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">value</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
            
            <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="k">instanceof</span> <span class="nx">Data</span><span class="p">.</span><span class="nb">Object</span> <span class="o">&amp;&amp;</span> <span class="nx">_</span><span class="p">.</span><span class="nx">intersect</span><span class="p">(</span><span class="nx">types</span><span class="p">,</span> <span class="nx">value</span><span class="p">.</span><span class="nx">types</span><span class="p">().</span><span class="nx">keys</span><span class="p">()).</span><span class="nx">length</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
            
            <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">value</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">_</span><span class="p">.</span><span class="nx">include</span><span class="p">(</span><span class="nx">types</span><span class="p">,</span> <span class="nx">value</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()))</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
          <span class="p">}</span>
          </pre></div>             </td>           </tr>                               <tr id="section-109">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-109">&#182;</a>               </div>               <p>Unique properties</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="k">if</span> <span class="p">(</span><span class="nx">property</span><span class="p">.</span><span class="nx">unique</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">validType</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">),</span> <span class="nx">types</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">that</span><span class="p">.</span><span class="nx">errors</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">property</span><span class="o">:</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">message</span><span class="o">:</span> <span class="s2">&quot;Invalid type for property \&quot;&quot;</span> <span class="o">+</span> <span class="nx">property</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s2">&quot;\&quot;&quot;</span><span class="p">});</span>
          <span class="p">}</span>
          </pre></div>             </td>           </tr>                               <tr id="section-110">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-110">&#182;</a>               </div>               <p>Non unique properties</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">property</span><span class="p">.</span><span class="nx">unique</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">_</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">).</span><span class="nx">values</span><span class="p">(),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">validType</span><span class="p">(</span><span class="nx">v</span><span class="p">,</span> <span class="nx">types</span><span class="p">);</span> <span class="p">}))</span> <span class="p">{</span>
            <span class="nx">that</span><span class="p">.</span><span class="nx">errors</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">property</span><span class="o">:</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">message</span><span class="o">:</span> <span class="s2">&quot;Invalid value type for property \&quot;&quot;</span> <span class="o">+</span> <span class="nx">property</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s2">&quot;\&quot;&quot;</span><span class="p">});</span>
          <span class="p">}</span>
        <span class="p">}</span>
        </pre></div>             </td>           </tr>                               <tr id="section-111">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-111">&#182;</a>               </div>               <p>Validator satisfied?</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="kd">function</span> <span class="nx">validValue</span><span class="p">()</span> <span class="p">{</span>
          <span class="k">return</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="nx">property</span><span class="p">.</span><span class="nx">validator</span><span class="p">).</span><span class="nx">test</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">));</span>
        <span class="p">}</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="nx">property</span><span class="p">.</span><span class="nx">validator</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">validValue</span><span class="p">())</span> <span class="p">{</span>
            <span class="nx">that</span><span class="p">.</span><span class="nx">errors</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">property</span><span class="o">:</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">message</span><span class="o">:</span> <span class="s2">&quot;Invalid value for property \&quot;&quot;</span> <span class="o">+</span> <span class="nx">property</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s2">&quot;\&quot;&quot;</span><span class="p">});</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">});</span>
      
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">errors</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-112">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-112">&#182;</a>               </div>               <p>Helper to create an object reference</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">newReference</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;objects&#39;</span><span class="p">,</span> <span class="nx">id</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-113">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-113">&#182;</a>               </div>               <p>Register the object (even if not yet loaded)</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">obj</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Data</span><span class="p">.</span><span class="nb">Object</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">g</span><span class="p">,</span> <span class="nx">id</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;objects&#39;</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">obj</span><span class="p">);</span>
      <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-114">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-114">&#182;</a>               </div>               <p>Register referenced <code>Data.Objects</code> on the object</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">obj</span><span class="p">.</span><span class="nx">referencedObjects</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">key</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">obj</span><span class="p">;</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-115">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-115">&#182;</a>               </div>               <p>Set an object type property</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">setObjectProperty</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="nx">values</span><span class="p">)</span>  <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      
      <span class="nx">that</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">key</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Data</span><span class="p">.</span><span class="nx">Hash</span><span class="p">());</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">values</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">v</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">v</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span> <span class="c1">// skip</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">v</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">v</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">v</span><span class="p">).</span><span class="nx">_id</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">newReference</span><span class="p">(</span><span class="nx">v</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">prevKeys</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">key</span><span class="p">).</span><span class="nx">keys</span><span class="p">();</span>
        <span class="nx">that</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">key</span><span class="p">,</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">key</span><span class="p">,</span> <span class="nx">obj</span><span class="p">);</span>
        
        <span class="nx">that</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;set&#39;</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">key</span><span class="p">,</span> <span class="nx">that</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">key</span><span class="p">).</span><span class="nx">keys</span><span class="p">(),</span> <span class="nx">prevKeys</span><span class="p">);</span>
        </pre></div>             </td>           </tr>                               <tr id="section-116">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-116">&#182;</a>               </div>               <p>p.registerValue(obj.key, obj);
Register values on property - now automatically triggerd by set events
p.set('values', obj.key, obj);</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="p">});</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-117">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-117">&#182;</a>               </div>               <p>Set a value type property</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">setValueProperty</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="nx">values</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-118">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-118">&#182;</a>               </div>               <p>Reset property</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">that</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">key</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Data</span><span class="p">.</span><span class="nx">Hash</span><span class="p">());</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">values</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">v</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">val</span> <span class="o">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;values&#39;</span><span class="p">,</span> <span class="nx">v</span><span class="p">);</span>
        </pre></div>             </td>           </tr>                               <tr id="section-119">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-119">&#182;</a>               </div>               <p>TODO: Move all val related code to registerValue()
Check if the value is already registered
on this property</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">val</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Data</span><span class="p">.</span><span class="nx">Node</span><span class="p">({</span><span class="nx">value</span><span class="o">:</span> <span class="nx">v</span><span class="p">});</span>
          <span class="nx">val</span><span class="p">.</span><span class="nx">referencedObjects</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Data</span><span class="p">.</span><span class="nx">Hash</span><span class="p">();</span>
        <span class="p">}</span>
        
        <span class="kd">var</span> <span class="nx">prevKeys</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">key</span><span class="p">).</span><span class="nx">keys</span><span class="p">();</span>
        <span class="nx">that</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">key</span><span class="p">,</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">val</span><span class="p">);</span>
        <span class="nx">that</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;set&#39;</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">key</span><span class="p">,</span> <span class="nx">that</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">key</span><span class="p">).</span><span class="nx">keys</span><span class="p">(),</span> <span class="nx">prevKeys</span><span class="p">);</span>
        </pre></div>             </td>           </tr>                               <tr id="section-120">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-120">&#182;</a>               </div>               <p>Register associated <code>Data.Objects</code> on the value <br />
val.referencedObjects.set(that.key, that);
that.set(p.key, v, val);
p.set('values', v, val);</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="p">});</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-121">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-121">&#182;</a>               </div>               <p>There are four different access scenarios for getting a certain property</p>

<ul>
<li>Unique value types</li>
<li>Non-unique value types</li>
<li>Unique object types </li>
<li>Non-Unique object types </li>
</ul>

<p>For convenience there's a get method, which always returns the right
result depending on the schema information. However, internally, every
property of a resource is represented as a non-unique <code>Data.Hash</code> 
of <code>Data.Node</code> objects, even if it's a unique property. So if you want 
to be explicit you should use the native methods of <code>Data.Node</code>. If
two arguments are provided <code>get</code> delegates to <code>Data.Node#get</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>    
    <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">property</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">properties</span><span class="p">().</span><span class="nx">get</span><span class="p">(</span><span class="nx">property</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">p</span><span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    
      <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">isObjectType</span><span class="p">())</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">p</span><span class="p">.</span><span class="nx">unique</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">first</span><span class="p">(</span><span class="nx">property</span><span class="p">)</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">property</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">p</span><span class="p">.</span><span class="nx">unique</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">value</span><span class="p">(</span><span class="nx">property</span><span class="p">)</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">values</span><span class="p">(</span><span class="nx">property</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">Data</span><span class="p">.</span><span class="nx">Node</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">get</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">property</span><span class="p">,</span> <span class="nx">key</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-122">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-122">&#182;</a>               </div>               <p>Get a property asynchronously
Handles cases where an object is not yet populated with data</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">getAsync</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">property</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">fetch</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">_id</span><span class="p">},</span> <span class="p">{},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">err</span> <span class="o">?</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="o">:</span> <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">that</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">property</span><span class="p">));</span>
        <span class="p">});</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">that</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">property</span><span class="p">));</span> <span class="c1">// Delegate to Data.Object#get</span>
      <span class="p">}</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-123">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-123">&#182;</a>               </div>               <p>Sets properties on the object
Existing properties are overridden / replaced</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">set</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">properties</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">properties</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-124">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-124">&#182;</a>               </div>               <p>TODO: improve this</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="kd">var</span> <span class="nx">prevValues</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="nx">that</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">key</span><span class="p">).</span><span class="nx">keys</span><span class="p">()</span> <span class="o">:</span> <span class="p">[];</span>
          <span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">properties</span><span class="p">().</span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">p</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span> <span class="c1">// Property not found on type</span>
          
          <span class="k">if</span> <span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">isObjectType</span><span class="p">())</span> <span class="p">{</span>
            <span class="nx">that</span><span class="p">.</span><span class="nx">setObjectProperty</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">?</span> <span class="nx">value</span> <span class="o">:</span> <span class="p">[</span><span class="nx">value</span><span class="p">]);</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">that</span><span class="p">.</span><span class="nx">setValueProperty</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">?</span> <span class="nx">value</span> <span class="o">:</span> <span class="p">[</span><span class="nx">value</span><span class="p">]);</span>
          <span class="p">}</span>
          
          <span class="nx">that</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;set&#39;</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">that</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">key</span><span class="p">).</span><span class="nx">keys</span><span class="p">(),</span> <span class="nx">prevValues</span><span class="p">);</span>
          <span class="nx">that</span><span class="p">.</span><span class="nx">dirty</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
          <span class="nx">that</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;dirty&#39;</span><span class="p">);</span>
        <span class="p">});</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">Data</span><span class="p">.</span><span class="nx">Node</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">arguments</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">arguments</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
      <span class="p">}</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-125">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-125">&#182;</a>               </div>               <p>Serialize an <code>Data.Object</code>'s properties</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">toJSON</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      <span class="nx">result</span> <span class="o">=</span> <span class="p">{};</span>
      
      <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_properties</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">properties</span><span class="p">().</span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">isObjectType</span><span class="p">())</span> <span class="p">{</span>
          <span class="nx">result</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">unique</span> <span class="o">?</span> <span class="nx">that</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">key</span><span class="p">).</span><span class="nx">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="nx">that</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">key</span><span class="p">).</span><span class="nx">keys</span><span class="p">()</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">result</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">unique</span> <span class="o">?</span> <span class="nx">that</span><span class="p">.</span><span class="nx">value</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="o">:</span> <span class="nx">that</span><span class="p">.</span><span class="nx">values</span><span class="p">(</span><span class="nx">key</span><span class="p">).</span><span class="nx">values</span><span class="p">();</span>
        <span class="p">}</span>
      <span class="p">});</span>
      
      <span class="nx">result</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">types</span><span class="p">().</span><span class="nx">keys</span><span class="p">();</span>
      <span class="nx">result</span><span class="p">[</span><span class="s1">&#39;_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_id</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_rev</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="nx">result</span><span class="p">[</span><span class="s1">&#39;_rev&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_rev</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_deleted</span><span class="p">)</span> <span class="nx">result</span><span class="p">[</span><span class="s1">&#39;_deleted&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_deleted</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">});</span>
  
  <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">Data</span><span class="p">.</span><span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">Events</span><span class="p">);</span>
  
  </pre></div>             </td>           </tr>                               <tr id="section-126">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-126">&#182;</a>               </div>               <h2>Data.Graph</h2>             </td>             <td class="code">               <div class="highlight"><pre>  </pre></div>             </td>           </tr>                               <tr id="section-127">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-127">&#182;</a>               </div>               <p>A <code>Data.Graph</code> can be used for representing arbitrary complex object
graphs. Relations between objects are expressed through links that
point to referred objects. Data.Graphs can be traversed in various ways.
See the testsuite for usage.</p>             </td>             <td class="code">               <div class="highlight"><pre>  
  <span class="nx">Data</span><span class="p">.</span><span class="nx">Graph</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">inherits</span><span class="p">(</span><span class="nx">Data</span><span class="p">.</span><span class="nx">Node</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">constructor</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">g</span><span class="p">,</span> <span class="nx">dirty</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      <span class="nx">Data</span><span class="p">.</span><span class="nx">Node</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;objects&#39;</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Data</span><span class="p">.</span><span class="nx">Hash</span><span class="p">());</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">g</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">merge</span><span class="p">(</span><span class="nx">g</span><span class="p">,</span> <span class="nx">dirty</span><span class="p">);</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-128">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-128">&#182;</a>               </div>               <p>Merges in another Graph</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">merge</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">g</span><span class="p">,</span> <span class="nx">dirty</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      </pre></div>             </td>           </tr>                               <tr id="section-129">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-129">&#182;</a>               </div>               <p>Process schema nodes</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">types</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="nx">g</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;/type/type&#39;</span> <span class="o">||</span> <span class="nx">node</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;type&#39;</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">that</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;objects&#39;</span><span class="p">,</span> <span class="nx">key</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">that</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;objects&#39;</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Data</span><span class="p">.</span><span class="nx">Type</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">node</span><span class="p">));</span>
            <span class="nx">that</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">).</span><span class="nx">dirty</span> <span class="o">=</span> <span class="nx">dirty</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">});</span>
      </pre></div>             </td>           </tr>                               <tr id="section-130">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-130">&#182;</a>               </div>               <p>Process object nodes</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">objects</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="nx">g</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">type</span> <span class="o">!==</span> <span class="s1">&#39;/type/type&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">node</span><span class="p">.</span><span class="nx">type</span> <span class="o">!==</span> <span class="s1">&#39;type&#39;</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;objects&#39;</span><span class="p">,</span> <span class="nx">key</span><span class="p">);</span>
          <span class="kd">var</span> <span class="nx">types</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span> <span class="o">?</span> <span class="nx">node</span><span class="p">.</span><span class="nx">type</span> <span class="o">:</span> <span class="p">[</span><span class="nx">node</span><span class="p">.</span><span class="nx">type</span><span class="p">];</span>
          
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">res</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Data</span><span class="p">.</span><span class="nb">Object</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">node</span><span class="p">);</span>
            <span class="nx">that</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;objects&#39;</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-131">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-131">&#182;</a>               </div>               <p>Populate existing node with data in order to be rebuilt</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">res</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">node</span><span class="p">;</span>
          <span class="p">}</span>
          </pre></div>             </td>           </tr>                               <tr id="section-132">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-132">&#182;</a>               </div>               <p>Check for type existence</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">types</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">that</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;objects&#39;</span><span class="p">,</span> <span class="nx">type</span><span class="p">))</span> <span class="p">{</span>
              <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Type &#39;&quot;</span><span class="o">+</span><span class="nx">type</span><span class="o">+</span><span class="s2">&quot;&#39; not found for &quot;</span><span class="o">+</span><span class="nx">key</span><span class="o">+</span><span class="s2">&quot;...&quot;</span><span class="p">);</span>
              <span class="k">throw</span> <span class="s2">&quot;Type &#39;&quot;</span><span class="o">+</span><span class="nx">type</span><span class="o">+</span><span class="s2">&quot;&#39; not found for &quot;</span><span class="o">+</span><span class="nx">key</span><span class="o">+</span><span class="s2">&quot;...&quot;</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nx">that</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;objects&#39;</span><span class="p">,</span> <span class="nx">type</span><span class="p">).</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;objects&#39;</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
          <span class="p">});</span>
          
          <span class="nx">that</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">).</span><span class="nx">dirty</span> <span class="o">=</span> <span class="nx">dirty</span><span class="p">;</span>
          
          <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-133">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-133">&#182;</a>               </div>               <p>Now that all objects are registered we can build them</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">this</span><span class="p">.</span><span class="nx">objects</span><span class="p">().</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">r</span><span class="p">.</span><span class="nx">build</span><span class="p">();</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-134">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-134">&#182;</a>               </div>               <p>Set (add) a new node on the graph</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">set</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">properties</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">types</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">properties</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span> <span class="o">?</span> <span class="nx">properties</span><span class="p">.</span><span class="nx">type</span> <span class="o">:</span> <span class="p">[</span><span class="nx">properties</span><span class="p">.</span><span class="nx">type</span><span class="p">];</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">id</span> <span class="o">=</span> <span class="nx">id</span> <span class="o">?</span> <span class="nx">id</span> <span class="o">:</span> <span class="nx">Data</span><span class="p">.</span><span class="nx">uuid</span><span class="p">(</span><span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">_</span><span class="p">.</span><span class="nx">last</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">last</span><span class="p">(</span><span class="nx">types</span><span class="p">).</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">);</span>
        
        <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Data</span><span class="p">.</span><span class="nb">Object</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">properties</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">dirty</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">build</span><span class="p">();</span>
        
        <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;objects&#39;</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;objects&#39;</span><span class="p">,</span> <span class="nx">id</span><span class="p">);</span>
        
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// Delegate to Data.Node#set</span>
        <span class="k">return</span> <span class="nx">Data</span><span class="p">.</span><span class="nx">Node</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">arguments</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">arguments</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
      <span class="p">}</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-135">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-135">&#182;</a>               </div>               <p>API method for accessing objects in the graph space
TODO: Ask the datastore if the node is not known in the local graph
      use async method queues for this!</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;objects&#39;</span><span class="p">,</span> <span class="nx">id</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">Data</span><span class="p">.</span><span class="nx">Node</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">get</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">arguments</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
      <span class="p">}</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-136">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-136">&#182;</a>               </div>               <p>Get a node asynchronously
Handles cases where an object is not yet there and needs to be fetched from
the server first</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">getAsync</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span>
          <span class="nx">node</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">node</span> <span class="o">||</span> <span class="o">!</span><span class="nx">node</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">that</span><span class="p">.</span><span class="nx">fetch</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span> <span class="nx">id</span><span class="p">},</span> <span class="p">{},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">err</span> <span class="o">?</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="o">:</span> <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">that</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">id</span><span class="p">));</span>
        <span class="p">});</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-137">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-137">&#182;</a>               </div>               <p>Delegate to Data.Graph#get</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">node</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-138">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-138">&#182;</a>               </div>               <p>Delete node by id, referenced nodes remain untouched</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">del</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">node</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">node</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
      <span class="nx">node</span><span class="p">.</span><span class="nx">_deleted</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="nx">node</span><span class="p">.</span><span class="nx">dirty</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;dirty&#39;</span><span class="p">);</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-139">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-139">&#182;</a>               </div>               <p>Find objects that match a particular query</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">find</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">qry</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">objects</span><span class="p">().</span><span class="nx">select</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">so</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">();</span>
        <span class="kd">var</span> <span class="nx">rejected</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">qry</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">condition</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-140">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-140">&#182;</a>               </div>               <p>Extract operator</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="kd">var</span> <span class="nx">matches</span> <span class="o">=</span> <span class="nx">key</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/^([a-z_]{1,30})(!=|&gt;|&gt;=|&lt;|&lt;=|\|=|&amp;=)?$/</span><span class="p">),</span>
              <span class="nx">property</span> <span class="o">=</span> <span class="nx">matches</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
              <span class="nx">operator</span> <span class="o">=</span> <span class="nx">matches</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">||</span> <span class="s1">&#39;==&#39;</span><span class="p">;</span>
          
          <span class="k">if</span> <span class="p">(</span><span class="nx">operator</span> <span class="o">===</span> <span class="s2">&quot;|=&quot;</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// one of operator</span>
            <span class="kd">var</span> <span class="nx">values</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">?</span> <span class="nx">value</span> <span class="o">:</span> <span class="p">[</span><span class="nx">value</span><span class="p">];</span>
            <span class="kd">var</span> <span class="nx">objectValues</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">so</span><span class="p">[</span><span class="nx">property</span><span class="p">])</span> <span class="o">?</span> <span class="nx">so</span><span class="p">[</span><span class="nx">property</span><span class="p">]</span> <span class="o">:</span> <span class="p">[</span><span class="nx">so</span><span class="p">[</span><span class="nx">property</span><span class="p">]];</span>
            <span class="nx">condition</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
            <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">values</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">include</span><span class="p">(</span><span class="nx">objectValues</span><span class="p">,</span> <span class="nx">val</span><span class="p">))</span> <span class="p">{</span>
                <span class="nx">condition</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
              <span class="p">}</span>
            <span class="p">});</span>
          <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">operator</span> <span class="o">===</span> <span class="s2">&quot;&amp;=&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">values</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">?</span> <span class="nx">value</span> <span class="o">:</span> <span class="p">[</span><span class="nx">value</span><span class="p">];</span>
            <span class="kd">var</span> <span class="nx">objectValues</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">so</span><span class="p">[</span><span class="nx">property</span><span class="p">])</span> <span class="o">?</span> <span class="nx">so</span><span class="p">[</span><span class="nx">property</span><span class="p">]</span> <span class="o">:</span> <span class="p">[</span><span class="nx">so</span><span class="p">[</span><span class="nx">property</span><span class="p">]];</span>
            <span class="nx">condition</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">intersect</span><span class="p">(</span><span class="nx">objectValues</span><span class="p">,</span> <span class="nx">values</span><span class="p">).</span><span class="nx">length</span> <span class="o">===</span> <span class="nx">values</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// regular operators</span>
            <span class="k">switch</span> <span class="p">(</span><span class="nx">operator</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">case</span> <span class="s2">&quot;!=&quot;</span><span class="o">:</span> <span class="nx">condition</span> <span class="o">=</span> <span class="o">!</span><span class="nx">_</span><span class="p">.</span><span class="nx">isEqual</span><span class="p">(</span><span class="nx">so</span><span class="p">[</span><span class="nx">property</span><span class="p">],</span> <span class="nx">value</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
              <span class="k">case</span> <span class="s2">&quot;&gt;&quot;</span><span class="o">:</span> <span class="nx">condition</span> <span class="o">=</span> <span class="nx">so</span><span class="p">[</span><span class="nx">property</span><span class="p">]</span> <span class="o">&gt;</span> <span class="nx">value</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
              <span class="k">case</span> <span class="s2">&quot;&gt;=&quot;</span><span class="o">:</span> <span class="nx">condition</span> <span class="o">=</span> <span class="nx">so</span><span class="p">[</span><span class="nx">property</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="nx">value</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
              <span class="k">case</span> <span class="s2">&quot;&lt;&quot;</span><span class="o">:</span> <span class="nx">condition</span> <span class="o">=</span> <span class="nx">so</span><span class="p">[</span><span class="nx">property</span><span class="p">]</span> <span class="o">&lt;</span> <span class="nx">value</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
              <span class="k">case</span> <span class="s2">&quot;&lt;=&quot;</span><span class="o">:</span> <span class="nx">condition</span> <span class="o">=</span> <span class="nx">so</span><span class="p">[</span><span class="nx">property</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="nx">value</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
              <span class="k">default</span> <span class="o">:</span> <span class="nx">condition</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isEqual</span><span class="p">(</span><span class="nx">so</span><span class="p">[</span><span class="nx">property</span><span class="p">],</span> <span class="nx">value</span><span class="p">);</span>
            <span class="p">}</span>
          <span class="p">}</span>
          
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">condition</span><span class="p">)</span> <span class="nx">rejected</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">});</span>
        <span class="k">return</span> <span class="o">!</span><span class="nx">rejected</span><span class="p">;</span>
      <span class="p">});</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-141">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-141">&#182;</a>               </div>               <p>Fetches a new subgraph from the adapter and either merges the new nodes
into the current set of nodes or replaces the graph completely with
the query result</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">fetch</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">qry</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      
      <span class="nx">Data</span><span class="p">.</span><span class="nx">adapter</span><span class="p">.</span><span class="nx">readGraph</span><span class="p">(</span><span class="nx">qry</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">graph</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">graph</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">that</span><span class="p">.</span><span class="nx">merge</span><span class="p">(</span><span class="nx">graph</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
        <span class="p">}</span> <span class="c1">// else no nodes found</span>
        
        <span class="nx">err</span> <span class="o">?</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="o">:</span> <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">graph</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-142">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-142">&#182;</a>               </div>               <p>Synchronize dirty nodes with the database</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">sync</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">callback</span> <span class="o">=</span> <span class="nx">callback</span> <span class="o">||</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{};</span>
      <span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span>
          <span class="nx">nodes</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">dirtyNodes</span><span class="p">();</span>
      
      <span class="kd">var</span> <span class="nx">validNodes</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Data</span><span class="p">.</span><span class="nx">Hash</span><span class="p">();</span>
      </pre></div>             </td>           </tr>                               <tr id="section-143">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-143">&#182;</a>               </div>               <p>Validate nodes</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">invalidNodes</span> <span class="o">=</span> <span class="nx">nodes</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">node</span><span class="p">.</span><span class="nx">validate</span> <span class="o">||</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">validate</span> <span class="o">&amp;&amp;</span> <span class="nx">node</span><span class="p">.</span><span class="nx">validate</span><span class="p">()))</span> <span class="p">{</span>
          <span class="nx">validNodes</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">node</span><span class="p">);</span>
          <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">});</span>
      
      <span class="nx">Data</span><span class="p">.</span><span class="nx">adapter</span><span class="p">.</span><span class="nx">writeGraph</span><span class="p">(</span><span class="nx">validNodes</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">(),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">g</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">that</span><span class="p">.</span><span class="nx">merge</span><span class="p">(</span><span class="nx">g</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-144">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-144">&#182;</a>               </div>               <p>No dirty nodes after sync</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nx">that</span><span class="p">.</span><span class="nx">dirtyNodes</span><span class="p">().</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">n</span><span class="p">.</span><span class="nx">dirty</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
          <span class="p">});</span>
          </pre></div>             </td>           </tr>                               <tr id="section-145">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-145">&#182;</a>               </div>               <p>Check if there are conflicts</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="kd">var</span> <span class="nx">conflictedNodes</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="nx">g</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">node</span><span class="p">.</span><span class="nx">_conflicted</span> <span class="p">});</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">conflictedNodes</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">that</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;conflicted&#39;</span><span class="p">);</span>
          <span class="nx">callback</span><span class="p">(</span><span class="nx">invalidNodes</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="s1">&#39;Some invalid nodes&#39;</span> <span class="o">:</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">invalidNodes</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-146">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-146">&#182;</a>               </div>               <p>Perform a filter on the graph. Expects <code>Data.Criterion</code> object
describing the filter conditions
DEPRECATED, will be removed with 0.3.0</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">filter</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">criteria</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">g2</span> <span class="o">=</span> <span class="p">{};</span>
      </pre></div>             </td>           </tr>                               <tr id="section-147">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-147">&#182;</a>               </div>               <p>Include schema information from the original graph</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">this</span><span class="p">.</span><span class="nx">types</span><span class="p">().</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">g2</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">type</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">();</span>
      <span class="p">});</span>
      </pre></div>             </td>           </tr>                               <tr id="section-148">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-148">&#182;</a>               </div>               <p>Include all other objects that do not match the target type
KNOWN BUG: this assumes that all type properties on all nested criterion
objects have the same type</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">this</span><span class="p">.</span><span class="nx">objects</span><span class="p">().</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_</span><span class="p">.</span><span class="nx">include</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">types</span><span class="p">().</span><span class="nx">keys</span><span class="p">(),</span> <span class="nx">criteria</span><span class="p">.</span><span class="nx">type</span><span class="p">))</span> <span class="nx">g2</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">();</span>
      <span class="p">});</span>
      </pre></div>             </td>           </tr>                               <tr id="section-149">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-149">&#182;</a>               </div>               <p>Include matched object nodes</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">criteria</span><span class="p">.</span><span class="nx">run</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">g2</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">();</span>
      <span class="p">});</span>

      <span class="k">return</span> <span class="k">new</span> <span class="nx">Data</span><span class="p">.</span><span class="nx">Graph</span><span class="p">(</span><span class="nx">g2</span><span class="p">);</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-150">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-150">&#182;</a>               </div>               <p>Perform a group operation on a Data.Graph</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">group</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">keys</span><span class="p">,</span> <span class="nx">properties</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Data</span><span class="p">.</span><span class="nx">Collection</span><span class="p">();</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">g</span> <span class="o">=</span> <span class="nx">Data</span><span class="p">.</span><span class="nx">Transformers</span><span class="p">.</span><span class="nx">group</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">keys</span><span class="p">,</span> <span class="nx">properties</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">res</span><span class="p">;</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-151">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-151">&#182;</a>               </div>               <p>Type nodes</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">types</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="s1">&#39;objects&#39;</span><span class="p">).</span><span class="nx">select</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">node</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;/type/type&#39;</span> <span class="o">||</span> <span class="nx">node</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;type&#39;</span><span class="p">;</span>
      <span class="p">});</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-152">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-152">&#182;</a>               </div>               <p>Object nodes</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">objects</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="s1">&#39;objects&#39;</span><span class="p">).</span><span class="nx">select</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">node</span><span class="p">.</span><span class="nx">type</span> <span class="o">!==</span> <span class="s1">&#39;/type/type&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">node</span><span class="p">.</span><span class="nx">type</span> <span class="o">!==</span> <span class="s1">&#39;type&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">node</span><span class="p">.</span><span class="nx">data</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">node</span><span class="p">.</span><span class="nx">_deleted</span><span class="p">;</span>
      <span class="p">});</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-153">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-153">&#182;</a>               </div>               <p>Get dirty nodes
Used by Data.Graph#sync</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">dirtyNodes</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="s1">&#39;objects&#39;</span><span class="p">).</span><span class="nx">select</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">dirty</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">data</span> <span class="o">||</span> <span class="nx">obj</span> <span class="k">instanceof</span> <span class="nx">Data</span><span class="p">.</span><span class="nx">Type</span><span class="p">));</span>
      <span class="p">});</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-154">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-154">&#182;</a>               </div>               <p>Get invalid nodes</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">invalidNodes</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="s1">&#39;objects&#39;</span><span class="p">).</span><span class="nx">select</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">errors</span> <span class="o">&amp;&amp;</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">errors</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-155">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-155">&#182;</a>               </div>               <p>Get conflicted nodes</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">conflictedNodes</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="s1">&#39;objects&#39;</span><span class="p">).</span><span class="nx">select</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">_conflicted</span><span class="p">;</span>
      <span class="p">});</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-156">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-156">&#182;</a>               </div>               <p>Serializes the graph to the JSON-based exchange format</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">toJSON</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">{};</span>
      </pre></div>             </td>           </tr>                               <tr id="section-157">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-157">&#182;</a>               </div>               <p>Serialize object nodes</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">this</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="s1">&#39;objects&#39;</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-158">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-158">&#182;</a>               </div>               <p>Only serialize fetched nodes</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">data</span> <span class="o">||</span> <span class="nx">obj</span> <span class="k">instanceof</span> <span class="nx">Data</span><span class="p">.</span><span class="nx">Type</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">result</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">();</span>
        <span class="p">}</span>
      <span class="p">});</span>
      
      <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">});</span>
  
  <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">Data</span><span class="p">.</span><span class="nx">Graph</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">Events</span><span class="p">);</span>
  </pre></div>             </td>           </tr>                               <tr id="section-159">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-159">&#182;</a>               </div>               <h2>Data.Collection</h2>             </td>             <td class="code">               <div class="highlight"><pre>  </pre></div>             </td>           </tr>                               <tr id="section-160">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-160">&#182;</a>               </div>               <p>A Collection is a simple data abstraction format where a dataset under
investigation conforms to a collection of data items that describes all
facets of the underlying data in a simple and universal way. You can
think of a Collection as a table of data, except it provides precise
information about the data contained (meta-data). A Data.Collection
just wraps a <code>Data.Graph</code> internally, in order to simplify the interface,
for cases where you do not have to deal with linked data.</p>             </td>             <td class="code">               <div class="highlight"><pre>  
  <span class="nx">Data</span><span class="p">.</span><span class="nx">Collection</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">spec</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span>
        <span class="nx">gspec</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;/type/item&quot;</span><span class="o">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="o">:</span> <span class="s2">&quot;/type/type&quot;</span><span class="p">,</span> <span class="s2">&quot;properties&quot;</span><span class="o">:</span> <span class="p">{}}};</span>
        </pre></div>             </td>           </tr>                               <tr id="section-161">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-161">&#182;</a>               </div>               <p>Convert to Data.Graph serialization format</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">spec</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">spec</span><span class="p">.</span><span class="nx">properties</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">property</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">gspec</span><span class="p">[</span><span class="s2">&quot;/type/item&quot;</span><span class="p">].</span><span class="nx">properties</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">property</span><span class="p">;</span>
      <span class="p">});</span>
      
      <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">spec</span><span class="p">.</span><span class="nx">items</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">gspec</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">item</span><span class="p">;</span>
        <span class="nx">gspec</span><span class="p">[</span><span class="nx">key</span><span class="p">].</span><span class="nx">type</span> <span class="o">=</span> <span class="s2">&quot;/type/item&quot;</span><span class="p">;</span>
      <span class="p">});</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">g</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Data</span><span class="p">.</span><span class="nx">Graph</span><span class="p">(</span><span class="nx">gspec</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">g</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Data</span><span class="p">.</span><span class="nx">Graph</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">};</span>
  
  <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">Data</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-162">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-162">&#182;</a>               </div>               <p>Get an object (item) from the collection</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">get</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">g</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-163">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-163">&#182;</a>               </div>               <p>Set (add) a new object to the collection</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">set</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">properties</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">properties</span><span class="p">,</span> <span class="p">{</span><span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;/type/item&quot;</span><span class="p">}));</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-164">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-164">&#182;</a>               </div>               <p>Find objects that match a particular query</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">find</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">qry</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">qry</span><span class="p">);</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-165">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-165">&#182;</a>               </div>               <p>Returns a filtered collection containing only items that match a certain query</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">filter</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">qry</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nx">Data</span><span class="p">.</span><span class="nx">Collection</span><span class="p">({</span>
        <span class="nx">properties</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">properties</span><span class="p">().</span><span class="nx">toJSON</span><span class="p">(),</span>
        <span class="nx">items</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">qry</span><span class="p">).</span><span class="nx">toJSON</span><span class="p">()</span>
      <span class="p">});</span>
    <span class="p">},</span>
        </pre></div>             </td>           </tr>                               <tr id="section-166">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-166">&#182;</a>               </div>               <p>Perform a group operation on the collection</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">group</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">keys</span><span class="p">,</span> <span class="nx">properties</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Data</span><span class="p">.</span><span class="nx">Collection</span><span class="p">();</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">g</span> <span class="o">=</span> <span class="nx">Data</span><span class="p">.</span><span class="nx">Transformers</span><span class="p">.</span><span class="nx">group</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">g</span><span class="p">,</span> <span class="s2">&quot;/type/item&quot;</span><span class="p">,</span> <span class="nx">keys</span><span class="p">,</span> <span class="nx">properties</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">res</span><span class="p">;</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-167">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-167">&#182;</a>               </div>               <p>Convenience function for accessing properties</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">properties</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;objects&#39;</span><span class="p">,</span> <span class="s1">&#39;/type/item&#39;</span><span class="p">).</span><span class="nx">all</span><span class="p">(</span><span class="s1">&#39;properties&#39;</span><span class="p">);</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-168">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-168">&#182;</a>               </div>               <p>Convenience function for accessing items</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">items</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">objects</span><span class="p">();</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-169">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-169">&#182;</a>               </div>               <p>Serialize</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">toJSON</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="p">{</span>
        <span class="nx">properties</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">()[</span><span class="s2">&quot;/type/item&quot;</span><span class="p">].</span><span class="nx">properties</span><span class="p">,</span>
        <span class="nx">items</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">objects</span><span class="p">().</span><span class="nx">toJSON</span><span class="p">()</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">});</span>

  </pre></div>             </td>           </tr>                               <tr id="section-170">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-170">&#182;</a>               </div>               <h2>Data.Criterion</h2>             </td>             <td class="code">               <div class="highlight"><pre>  </pre></div>             </td>           </tr>                               <tr id="section-171">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-171">&#182;</a>               </div>               <p>Deprecated. Will be removed with 0.3.0. Use Data.Graph.find instead</p>             </td>             <td class="code">               <div class="highlight"><pre>  
  <span class="nx">Data</span><span class="p">.</span><span class="nx">Criterion</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">operator</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">property</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">operator</span> <span class="o">=</span> <span class="nx">operator</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="nx">type</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">property</span> <span class="o">=</span> <span class="nx">property</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">children</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="p">};</span>
  
  <span class="nx">Data</span><span class="p">.</span><span class="nx">Criterion</span><span class="p">.</span><span class="nx">operators</span> <span class="o">=</span> <span class="p">{};</span>
  
  <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">Data</span><span class="p">.</span><span class="nx">Criterion</span><span class="p">.</span><span class="nx">operators</span><span class="p">,</span> <span class="p">{</span>
    </pre></div>             </td>           </tr>                               <tr id="section-172">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-172">&#182;</a>               </div>               <p>Logical Connectors</p>             </td>             <td class="code">               <div class="highlight"><pre>    
    <span class="nx">AND</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">criteria</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">criteria</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="k">new</span> <span class="nx">Data</span><span class="p">.</span><span class="nx">Hash</span><span class="p">();</span>
      <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">criteria</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">run</span><span class="p">(</span><span class="nx">target</span><span class="p">);</span>
      <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">criteria</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">result</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">intersect</span><span class="p">(</span><span class="nx">criteria</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">run</span><span class="p">(</span><span class="nx">target</span><span class="p">));</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">OR</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">criteria</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Data</span><span class="p">.</span><span class="nx">Hash</span><span class="p">();</span>
      <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">criteria</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">result</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">union</span><span class="p">(</span><span class="nx">criteria</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">run</span><span class="p">(</span><span class="nx">target</span><span class="p">));</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-173">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-173">&#182;</a>               </div>               <p>Logical Operators</p>             </td>             <td class="code">               <div class="highlight"><pre>    
    <span class="nx">CONTAINS</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">typeKey</span><span class="p">,</span> <span class="nx">propertyKey</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">target</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;objects&#39;</span><span class="p">,</span> <span class="nx">typeKey</span><span class="p">),</span>
          <span class="nx">property</span> <span class="o">=</span> <span class="nx">type</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;properties&#39;</span><span class="p">,</span> <span class="nx">propertyKey</span><span class="p">),</span>
          <span class="nx">v</span> <span class="o">=</span> <span class="nx">property</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;values&#39;</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
      </pre></div>             </td>           </tr>                               <tr id="section-174">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-174">&#182;</a>               </div>               <p>Only return results within the requested type range</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">return</span> <span class="nx">v</span><span class="p">.</span><span class="nx">referencedObjects</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">include</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">types</span><span class="p">().</span><span class="nx">keys</span><span class="p">(),</span> <span class="nx">typeKey</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-175">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-175">&#182;</a>               </div>               <p>Only works with value type properties</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">GT</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">typeKey</span><span class="p">,</span> <span class="nx">propertyKey</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">target</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;objects&#39;</span><span class="p">,</span> <span class="nx">typeKey</span><span class="p">),</span>
          <span class="nx">property</span> <span class="o">=</span> <span class="nx">type</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;properties&#39;</span><span class="p">,</span> <span class="nx">propertyKey</span><span class="p">),</span>
          <span class="nx">values</span> <span class="o">=</span> <span class="nx">property</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="s1">&#39;values&#39;</span><span class="p">),</span>
          <span class="nx">matchedObjects</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Data</span><span class="p">.</span><span class="nx">Hash</span><span class="p">();</span>
          
      <span class="nx">values</span> <span class="o">=</span> <span class="nx">values</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">v</span><span class="p">.</span><span class="nx">val</span> <span class="o">&gt;=</span> <span class="nx">value</span><span class="p">;</span>
      <span class="p">});</span>
      
      <span class="nx">values</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">matchedObjects</span> <span class="o">=</span> <span class="nx">matchedObjects</span><span class="p">.</span><span class="nx">union</span><span class="p">(</span><span class="nx">v</span><span class="p">.</span><span class="nx">referencedObjects</span><span class="p">);</span>
      <span class="p">});</span>
      <span class="k">return</span> <span class="nx">matchedObjects</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">});</span>
  
  <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">Data</span><span class="p">.</span><span class="nx">Criterion</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">add</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">criterion</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">criterion</span><span class="p">);</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-176">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-176">&#182;</a>               </div>               <p>Run criterion against a Data.Graph (target)
TODO: allow Data.Collections to be passed here too,
for Collections the type attribute can be derived automatically.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">run</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">target</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">operator</span> <span class="o">===</span> <span class="s2">&quot;AND&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">Data</span><span class="p">.</span><span class="nx">Criterion</span><span class="p">.</span><span class="nx">operators</span><span class="p">.</span><span class="nx">AND</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">operator</span> <span class="o">===</span> <span class="s2">&quot;OR&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">Data</span><span class="p">.</span><span class="nx">Criterion</span><span class="p">.</span><span class="nx">operators</span><span class="p">.</span><span class="nx">OR</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-177">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-177">&#182;</a>               </div>               <p>Leaf nodes</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">return</span> <span class="nx">Data</span><span class="p">.</span><span class="nx">Criterion</span><span class="p">.</span><span class="nx">operators</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">operator</span><span class="p">](</span><span class="nx">target</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">property</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">})();</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 